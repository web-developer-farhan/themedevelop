{% comment %}
  Featured Products Grid (OS 2.0)
  - Source: a collection OR a manual product list
  - Badges: "On sale" + "Best" (if product has tag 'best')
  - Reviews: uses metafields reviews.rating (scale 0–5) and reviews.count (optional)
  - Variant selector + Add to Cart works out of the box (non-AJAX)
{% endcomment %}

<section class="featured-grid section-{{ section.id }}">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h2 class="featured-grid__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    {% assign items = '' %}
    {% if section.settings.source == 'collection' and section.settings.collection != blank %}
      {% assign items = section.settings.collection.products | slice: 0, section.settings.limit %}
    {% else %}
      {% assign items = section.blocks | map: 'settings' | map: 'product' %}
      {% assign items = items | compact | slice: 0, section.settings.limit %}
    {% endif %}

    {% if items.size > 0 %}
      <div class="featured-grid__items cols-{{ section.settings.columns_desktop }} md:cols-{{ section.settings.columns_tablet }} sm:cols-{{ section.settings.columns_mobile }}">
        {% for product in items %}
          {% assign p = product %}

          <article class="card" data-product-handle="{{ p.handle }}">
            <a href="{{ p.url }}" class="card__media">
              {% assign img = p.featured_image %}
              {% if img %}
                <img loading="lazy" src="{{ img | image_url: width: 800 }}" alt="{{ img.alt | escape }}">
              {% else %}
                {{ 'product-1' | placeholder_svg_tag }}
              {% endif %}

              {% if section.settings.show_badges %}
                {% if p.compare_at_price_max > p.price %}
                  <span class="badge badge--sale">On sale</span>
                {% endif %}
                {% if p.tags contains 'best' %}
                  <span class="badge badge--best">Best</span>
                {% endif %}
              {% endif %}
            </a>

            <div class="card__content">
              <h3 class="card__title"><a href="{{ p.url }}">{{ p.title }}</a></h3>

              {% if section.settings.show_reviews %}
                {% assign rating = p.metafields.reviews.rating | default: 0 %}
                {% assign rating_count = p.metafields.reviews.count | default: 0 %}
                <div class="rating" aria-label="Rating {{ rating }} out of 5">
                  <div class="stars">
                    {% for i in (1..5) %}
                      {% if i <= rating %}
                        <span class="star">★</span>
                      {% else %}
                        <span class="star star--empty">☆</span>
                      {% endif %}
                    {% endfor %}
                  </div>
                  {% if rating_count > 0 %}
                    <span class="rating__count">{{ rating_count }} Reviews</span>
                  {% endif %}
                </div>
              {% endif %}

              <div class="price">
                {% if p.compare_at_price_max > p.price %}
                  <span class="price__current">{{ p.price | money }}</span>
                  <span class="price__compare">{{ p.compare_at_price_max | money }}</span>
                {% else %}
                  <span class="price__current">{{ p.price | money }}</span>
                {% endif %}
              </div>

              {% if section.settings.show_picker or section.settings.show_add %}
                <form method="post" action="/cart/add" class="card__form" data-product-id="{{ p.id }}">
                  {% if section.settings.show_picker %}
                    {% if p.variants.size > 1 %}
                      <select name="id" class="variant-select" aria-label="Select variant">
                        {% for v in p.variants %}
                          <option value="{{ v.id }}" {% if v == p.selected_or_first_available_variant %}selected{% endif %} {% unless v.available %}disabled{% endunless %}>
                            {{ v.title }} — {{ v.price | money }}{% unless v.available %} (Sold out){% endunless %}
                          </option>
                        {% endfor %}
                      </select>
                    {% else %}
                      <input type="hidden" name="id" value="{{ p.variants.first.id }}">
                    {% endif %}
                  {% else %}
                    <input type="hidden" name="id" value="{{ p.selected_or_first_available_variant.id }}">
                  {% endif %}

                  {% if section.settings.show_add %}
                    <button type="submit" class="btn btn--primary" {% unless p.available %}disabled{% endunless %}>
                      {% if p.available %}{{ section.settings.add_label }}{% else %}Sold out{% endif %}
                    </button>
                  {% endif %}
                </form>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <p>No products found. Pick a collection or add products as blocks.</p>
    {% endif %}
  </div>

  <style>
    .section-{{ section.id }} .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
    .featured-grid__heading { text-align: center; margin: 24px 0 16px; letter-spacing: .02em; }
    .featured-grid__items { display: grid; gap: 24px; }
    .featured-grid__items.cols-4 { grid-template-columns: repeat(4,1fr); }
    .featured-grid__items.cols-3 { grid-template-columns: repeat(3,1fr); }
    .featured-grid__items.cols-2 { grid-template-columns: repeat(2,1fr); }

    /* Responsive tweaks */
    @media (max-width: 991px){
      .featured-grid__items.md\:cols-3 { grid-template-columns: repeat(3,1fr); }
      .featured-grid__items.md\:cols-2 { grid-template-columns: repeat(2,1fr); }
    }
    @media (max-width: 640px){
      .featured-grid__items.sm\:cols-2 { grid-template-columns: repeat(2,1fr); }
      .featured-grid__items.sm\:cols-1 { grid-template-columns: repeat(1,1fr); }
    }

    .card { border: 1px solid rgba(0,0,0,.08); border-radius: 12px; overflow: hidden; background: #fff; display: flex; flex-direction: column; }
    .card__media { position: relative; display: block; padding: 12px; }
    .card__media img { width: 100%; height: auto; display: block; background: #f8f8f8; border-radius: 8px; }
    .badge { position: absolute; top: 16px; left: 16px; font-size: 12px; line-height: 1; padding: 6px 8px; border-radius: 4px; color: #fff; }
    .badge--sale { background: #c82333; }
    .badge--best { background: #111; left: auto; right: 16px; }

    .card__content { padding: 12px 16px 16px; display: grid; gap: 8px; }
    .card__title { font-size: 16px; margin: 0; }
    .card__title a { color: inherit; text-decoration: none; }
    .price { display: flex; gap: 8px; align-items: baseline; }
    .price__current { font-weight: 700; }
    .price__compare { color: #888; text-decoration: line-through; }

    .rating { display: flex; align-items: center; gap: 8px; }
    .stars { letter-spacing: 2px; font-size: 14px; }
    .star { font-size: 14px; }
    .star--empty { color: #bbb; }
    .rating__count { font-size: 12px; color: #666; }

    .card__form { display: grid; gap: 8px; }
    .variant-select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
    .btn { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    .btn--primary { background: #111; color: #fff; }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
  </style>

  <script>
    // Optional: update price on variant change (per card)
    document.querySelectorAll('.section-{{ section.id }} .card').forEach(function(card){
      const select = card.querySelector('.variant-select');
      if(!select) return;

      select.addEventListener('change', function(){
        const option = select.options[select.selectedIndex];
        const priceEl = card.querySelector('.price__current');
        if(option && priceEl){
          // Expect option label like: "Size — $12.00", keep it simple
          const parts = option.textContent.split('—');
          if(parts[1]) priceEl.textContent = parts[1].trim();
        }
      });
    });
  </script>
</section>

{% schema %}
{
  "name": "Featured products grid",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "BEST SELLERS" },
    {
      "type": "select",
      "id": "source",
      "label": "Product source",
      "options": [
        { "value": "collection", "label": "Collection" },
        { "value": "manual", "label": "Manual (blocks)" }
      ],
      "default": "collection"
    },
    { "type": "collection", "id": "collection", "label": "Collection (if source = Collection)" },
    { "type": "range", "id": "limit", "label": "Max products", "min": 1, "max": 24, "step": 1, "default": 8 },
    { "type": "checkbox", "id": "show_badges", "label": "Show badges", "default": true },
    { "type": "checkbox", "id": "show_reviews", "label": "Show rating (from metafields)", "default": true },
    { "type": "checkbox", "id": "show_picker", "label": "Show variant picker", "default": true },
    { "type": "checkbox", "id": "show_add", "label": "Show Add to Cart", "default": true },
    { "type": "text", "id": "add_label", "label": "Add button label", "default": "ADD" },
    {
      "type": "select",
      "id": "columns_desktop",
      "label": "Columns (desktop)",
      "options": [
        { "value": "4", "label": "4" },
        { "value": "3", "label": "3" },
        { "value": "2", "label": "2" }
      ],
      "default": "4"
    },
    {
      "type": "select",
      "id": "columns_tablet",
      "label": "Columns (tablet)",
      "options": [
        { "value": "3", "label": "3" },
        { "value": "2", "label": "2" }
      ],
      "default": "2"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "options": [
        { "value": "2", "label": "2" },
        { "value": "1", "label": "1" }
      ],
      "default": "2"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        { "type": "product", "id": "product", "label": "Product" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Featured products grid",
      "settings": { "heading": "BEST SELLERS" }
    }
  ]
}
{% endschema %}
